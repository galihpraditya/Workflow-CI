name: MLflow-Training-CI-CD

on:
  push:
    branches:
      - main
      - master
    paths:
      - "MLProject/**"
      - ".github/workflows/mlflow-ci.yml"

  pull_request:
    branches:
      - main
      - master
    paths:
      - "MLProject/**"

  workflow_dispatch: 

env:
  PYTHON_VERSION: "3.11"
  MLFLOW_VERSION: "2.10.0"

jobs:
  train:
    name: Train ML Models with MLflow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Dependencies
        run: |
          echo "Installing MLflow and required packages..."
          pip install --upgrade pip
          pip install mlflow>=${{ env.MLFLOW_VERSION }}
          pip install scikit-learn>=1.3.0
          pip install pandas>=2.0.0
          pip install numpy>=1.24.0
          pip install matplotlib>=3.7.0
          pip install seaborn>=0.12.0
          pip install joblib>=1.3.0
          pip install scipy>=1.11.0
          echo "Dependencies installed successfully!"

      - name: Verify MLProject Structure
        run: |
          echo "Checking MLProject folder structure..."
          ls -la MLProject/
          echo ""
          echo "Checking required files..."
          test -f MLProject/MLProject && echo "[OK] MLproject found" || echo "[ERROR] MLproject NOT found"
          test -f MLProject/conda.yaml && echo "[OK] conda.yaml found" || echo "[ERROR] conda.yaml NOT found"
          test -f MLProject/modelling.py && echo "[OK] modelling.py found" || echo "[ERROR] modelling.py NOT found"
          test -d MLProject/data_preprocessing && echo "[OK] Dataset folder found" || echo "[ERROR] Dataset folder NOT found"

      - name: Run Model Training with MLflow Project
        env:
          MLFLOW_TRACKING_URI: file:./mlruns
        run: |
          echo "Starting MLflow Project training..."
          cd MLProject
          mlflow run . \
            -P data_path=data_preprocessing \
            -P model_type=all \
            -P experiment_name=GitHub_Actions_CI \
            --env-manager=local
          echo "Training completed!"

      - name: List Generated Artifacts
        if: always() # Run even if training fails
        run: |
          echo "Listing MLflow artifacts..."
          if [ -d "MLProject/mlruns" ]; then
            echo "MLflow runs directory:"
            ls -lR MLProject/mlruns/
          else
            echo "[WARNING] No mlruns directory found"
          fi

          if [ -d "MLProject/mlartifacts" ]; then
            echo ""
            echo "MLflow artifacts directory:"
            ls -lR MLProject/mlartifacts/
          else
            echo "[WARNING] No mlartifacts directory found"
          fi

      - name: Upload MLflow Artifacts to GitHub
        uses: actions/upload-artifact@v4
        if: always() # Upload even if training fails (untuk debugging)
        with:
          name: mlflow-artifacts-${{ github.sha }}
          path: |
            MLProject/mlruns/
            MLProject/mlartifacts/
          retention-days: 30 
          if-no-files-found: warn

      - name: Generate Training Summary
        if: success()
        run: |
          echo "## Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "MLflow training completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts uploaded to GitHub Actions" >> $GITHUB_STEP_SUMMARY